name: Issue Evaluation Pipeline

on:
  issues:
    types: [opened]

permissions:
  contents: write        # push branches
  issues: write          # add labels, post comments
  pull-requests: write   # create draft PRs
  id-token: write        # Azure AD token exchange

jobs:
  # ‚îÄ‚îÄ Triage: classify the issue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  triage:
    runs-on: ubuntu-latest
    outputs:
      is_bug: ${{ steps.classify.outputs.is_bug }}
      is_feature: ${{ steps.classify.outputs.is_feature }}
      issue_type: ${{ steps.classify.outputs.issue_type }}
    steps:
      - name: Classify issue
        id: classify
        env:
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels.*.name) }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          LABELS="$ISSUE_LABELS"
          TITLE="$ISSUE_TITLE"
          IS_BUG=false
          IS_FEATURE=false

          if echo "$LABELS" | grep -qi "bug"; then
            IS_BUG=true
          elif echo "$LABELS" | grep -qi "feature\|enhancement"; then
            IS_FEATURE=true
          fi

          if [ "$IS_BUG" = "false" ] && [ "$IS_FEATURE" = "false" ]; then
            if echo "$TITLE" | grep -qi "^\[bug\]"; then
              IS_BUG=true
            elif echo "$TITLE" | grep -qi "^\[feature\]"; then
              IS_FEATURE=true
            fi
          fi

          ISSUE_TYPE="unknown"
          if [ "$IS_BUG" = "true" ]; then ISSUE_TYPE="bug"; fi
          if [ "$IS_FEATURE" = "true" ]; then ISSUE_TYPE="feature"; fi

          echo "is_bug=$IS_BUG" >> "$GITHUB_OUTPUT"
          echo "is_feature=$IS_FEATURE" >> "$GITHUB_OUTPUT"
          echo "issue_type=$ISSUE_TYPE" >> "$GITHUB_OUTPUT"

      - name: Add triage labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];
            if ('${{ steps.classify.outputs.is_bug }}' === 'true') labels.push('bug', 'auto-triage');
            if ('${{ steps.classify.outputs.is_feature }}' === 'true') labels.push('enhancement', 'auto-triage');
            if (labels.length === 0) labels.push('needs-triage');
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels,
            });

  # ‚îÄ‚îÄ Autonomous resolution: AI ‚Üí code ‚Üí PR ‚Üí test ‚Üí merge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  auto-resolve:
    needs: triage
    if: needs.triage.outputs.is_bug == 'true' || needs.triage.outputs.is_feature == 'true'
    runs-on: ubuntu-latest
    env:
      ISSUE_TYPE: ${{ needs.triage.outputs.issue_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install API dependencies
        run: cd api && npm ci

      - name: Build API
        run: cd api && npm run build

      # ‚îÄ‚îÄ Announce start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Post resolution start
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ env.ISSUE_TYPE }}';
            const icon = type === 'bug' ? 'üêõ' : '‚ú®';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                `${icon} **Autonomous resolution pipeline started**`,
                '',
                '| Step | Status |',
                '|------|--------|',
                '| Triage | ‚úÖ Classified |',
                '| AI analysis | üîÑ Running |',
                '| Code generation | ‚è≥ Pending |',
                '| Quality gates | ‚è≥ Pending |',
                '| Pull request | ‚è≥ Pending |',
                '| Auto-merge | ‚è≥ Pending |',
                '',
                `_Attempting autonomous resolution of #${context.issue.number}‚Ä¶_`,
              ].join('\n'),
            });

      # ‚îÄ‚îÄ Azure AD token for OpenAI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_SP_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_SP_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure AD token
        id: token
        run: |
          TOKEN=$(az account get-access-token \
            --resource https://cognitiveservices.azure.com \
            --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ AI resolution agent ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Run AI resolution agent
        id: resolve
        env:
          AZURE_OPENAI_ENDPOINT: https://parallax-atlas-ai.openai.azure.com
          AZURE_OPENAI_DEPLOYMENT: gpt-4o
          AZURE_AD_TOKEN: ${{ steps.token.outputs.token }}
          INPUT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          INPUT_ISSUE_TITLE: ${{ github.event.issue.title }}
          INPUT_ISSUE_BODY: ${{ github.event.issue.body }}
          INPUT_ISSUE_TYPE: ${{ env.ISSUE_TYPE }}
        run: |
          node scripts/resolve-issue.mjs \
            --issue-number "$INPUT_ISSUE_NUMBER" \
            --issue-title "$INPUT_ISSUE_TITLE" \
            --issue-body "$INPUT_ISSUE_BODY" \
            --issue-type "$INPUT_ISSUE_TYPE"

          if [ -f .ai-resolution.json ]; then
            CHANGES=$(node -e "const r=JSON.parse(require('fs').readFileSync('.ai-resolution.json','utf-8'));console.log(r.appliedCount||0)")
            ANALYSIS=$(node -e "const r=JSON.parse(require('fs').readFileSync('.ai-resolution.json','utf-8'));console.log(r.analysis||'')")
            COMMIT_MSG=$(node -e "const r=JSON.parse(require('fs').readFileSync('.ai-resolution.json','utf-8'));console.log(r.commitMessage||'')")
          else
            CHANGES=0
            ANALYSIS="No resolution file generated"
            COMMIT_MSG=""
          fi

          echo "changes=$CHANGES" >> "$GITHUB_OUTPUT"
          {
            echo "analysis<<ANALYSIS_EOF"
            echo "$ANALYSIS"
            echo "ANALYSIS_EOF"
          } >> "$GITHUB_OUTPUT"
          echo "commit_msg=$COMMIT_MSG" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ Validate AI-generated changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Lint (post-AI)
        id: lint
        if: steps.resolve.outputs.changes != '0'
        run: npm run lint
        continue-on-error: true

      - name: Build (post-AI)
        id: build
        if: steps.resolve.outputs.changes != '0'
        run: npm run build
        env:
          VITE_BING_MAPS_API_KEY: ${{ secrets.VITE_BING_MAPS_API_KEY }}
        continue-on-error: true

      - name: Install Playwright browsers
        if: steps.resolve.outputs.changes != '0'
        run: npx playwright install --with-deps chromium

      - name: E2E tests (post-AI)
        id: tests
        if: steps.resolve.outputs.changes != '0'
        run: npm run test:e2e
        continue-on-error: true

      # ‚îÄ‚îÄ Create PR if all gates pass ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Create resolution PR
        id: pr
        if: |
          steps.resolve.outputs.changes != '0' &&
          steps.lint.outcome == 'success' &&
          steps.build.outcome == 'success' &&
          steps.tests.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto-resolve/issue-${{ github.event.issue.number }}"
          COMMIT_MSG="${{ steps.resolve.outputs.commit_msg }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="fix: auto-resolve issue #${{ github.event.issue.number }}"
          fi

          git config user.name "parallax-atlas-bot"
          git config user.email "bot@parallax-atlas.dev"
          git checkout -b "$BRANCH"
          git add -A
          git rm -f --cached .ai-resolution.json 2>/dev/null || true
          git commit -m "$COMMIT_MSG" \
                    -m "Closes #${{ github.event.issue.number }}" \
                    -m "Auto-generated by AI resolution pipeline"
          git push origin "$BRANCH"

          PR_BODY="## AI-Resolved: Issue #${{ github.event.issue.number }}

          **Analysis:** ${{ steps.resolve.outputs.analysis }}

          ### Quality Gates
          | Gate | Result |
          |------|--------|
          | Lint | ‚úÖ Passed |
          | Build | ‚úÖ Passed |
          | E2E Tests | ‚úÖ Passed |

          ---
          Closes #${{ github.event.issue.number }}
          _Auto-generated by Parallax Atlas AI resolution pipeline_"

          PR_URL=$(gh pr create \
            --base dev \
            --head "$BRANCH" \
            --title "$COMMIT_MSG" \
            --body "$PR_BODY" \
            --label "auto-resolved" \
            --draft)

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ Notify ready for review (auto-merge removed per security policy) ‚îÄ‚îÄ
      - name: Mark PR ready for review notification
        if: steps.pr.outputs.pr_url != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Draft PR created: ${{ steps.pr.outputs.pr_url }}"
          echo "Human review required before merge (per security policy)."

      # ‚îÄ‚îÄ Report results to issue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Post resolution results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const changes = parseInt('${{ steps.resolve.outputs.changes }}' || '0');
            const analysis = `${{ steps.resolve.outputs.analysis }}`.replace(/`/g, "'");
            const lintOk  = '${{ steps.lint.outcome }}'  === 'success';
            const buildOk = '${{ steps.build.outcome }}' === 'success';
            const testsOk = '${{ steps.tests.outcome }}' === 'success';
            const prUrl   = '${{ steps.pr.outputs.pr_url }}' || '';
            const allPass = lintOk && buildOk && testsOk;
            const icon = (ok) => ok ? '‚úÖ' : '‚ùå';

            const body = [];

            if (changes === 0) {
              body.push(
                'ü§ñ **AI analysis complete ‚Äî no auto-resolution generated**',
                '',
                `**Analysis:** ${analysis}`,
                '',
                'The AI agent reviewed this issue but could not generate code changes.',
                'A maintainer will review manually.',
              );
            } else if (allPass && prUrl) {
              body.push(
                'üéâ **Autonomous resolution complete ‚Äî draft PR created**',
                '',
                `**Analysis:** ${analysis}`,
                '',
                '| Step | Status |',
                '|------|--------|',
                `| AI code generation | ‚úÖ ${changes} file(s) |`,
                `| Lint  | ${icon(lintOk)}  |`,
                `| Build | ${icon(buildOk)} |`,
                `| E2E   | ${icon(testsOk)} |`,
                `| PR    | ‚úÖ [Draft created](${prUrl}) |`,
                '| Review | üë§ Awaiting human review |',
                '',
                `**PR:** ${prUrl}`,
                '_Draft PR requires human review before merge (per security policy)._',
              );
            } else {
              body.push(
                '‚ö†Ô∏è **AI generated changes but quality gates failed**',
                '',
                `**Analysis:** ${analysis}`,
                '',
                '| Step | Status |',
                '|------|--------|',
                `| AI code generation | ‚úÖ ${changes} file(s) |`,
                `| Lint  | ${icon(lintOk)}  |`,
                `| Build | ${icon(buildOk)} |`,
                `| E2E   | ${icon(testsOk)} |`,
                '| PR | ‚ùå Blocked |',
                '',
                'Changes did not pass all quality gates. A maintainer will resolve manually.',
              );
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['needs-human-review'],
              });
            }

            body.push('', '_Automated by Parallax Atlas AI pipeline_');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body.join('\n'),
            });
